
<ol class="breadcrumb">
	<li><a ui-sref="main.projects" translate="shared.projects"></a></li>
	<li><a ui-sref="main.project.logical_frame({projectId: project._id})">{{project.name}}</a></li>
	<li><a ui-sref="main.project.forms({projectId: project._id})" translate="project.input_forms"></a></li>
	<li class="active">{{form.name}}</li>
</ol>

<form class="form-horizontal" role="form" name="formForm" novalidate>

	<fieldset>
		<legend translate="project.data_collection"></legend>

		<div class="form-group" show-errors>
			<label for="input-name" class="col-sm-2 control-label" translate="shared.name"></label>
			<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="form.name">
				<input type="text"
					   class="form-control"
					   id="input-name"
					   name="name"
					   ng-model="form.name"
					   placeholder="Exemple: Sondage trimestriel"
					   required />
				
				<p class="help-block" ng-if="formForm.name.$error.required" translate="form.mandatory"></p>
			</div>
		</div>

		<div class="form-group" show-errors>
			<label for="periodicity-input" class="col-sm-2 control-label" translate="project.periodicity"></label>
			<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="'project.'+form.periodicity|translate">
				<select class="form-control"
						name="periodicity"
						id="periodicity-input"
						ng-model="form.periodicity">
					<option value="monthly" translate="project.monthly"></option>
					<option value="quarterly" translate="project.quarterly"></option>
					<option value="planned" translate="project.planned"></option>
				</select>
			</div>
		</div>

		<div ng-if="form.periodicity == 'monthly' || form.periodicity == 'quarterly'">
			<div class="form-group" show-errors>
				<label for="periodicity" class="col-sm-2 control-label" translate="shared.begin"></label>
				<div class="col-sm-10">
					<div class="input-group" acl-has-project-role="owner">
						<div class="input-group-addon">
							<input type="checkbox" ng-model="form.useProjectStart" />
							{{'project.begin'|translate}}
						</div>

						<input type="month"
							   class="form-control"
							   ng-model="form.start"
							   ng-disabled="form.useProjectStart"
							   name="start"
							   ng-required="!form.useProjectStart" />
					</div>

					<p class="form-control-static" acl-lacks-project-role="owner">
						<span ng-if="form.useProjectStart" translate="project.begin"></span>
						<span ng-if="!form.useProjectStart">form.start</span>
					</p>
				</div>
			</div>

			<div class="form-group" show-errors>
				<label for="periodicity" class="col-sm-2 control-label" translate="shared.end"></label>
				<div class="col-sm-10">
					<div class="input-group" acl-has-project-role="owner">
						<div class="input-group-addon">
							<input type="checkbox" ng-model="form.useProjectEnd" />
							{{'project.end'|translate}}
						</div>

						<input type="month"
							   class="form-control"
							   ng-model="form.end"
							   ng-disabled="form.useProjectEnd"
							   name="end"
							   ng-required="!form.useProjectEnd" />
					</div>

					<p class="form-control-static" acl-lacks-project-role="owner">
						<span ng-if="form.useProjectEnd" translate="project.end"></span>
						<span ng-if="!form.useProjectEnd">{{form.end}}</span>
					</p>
				</div>
			</div>
		</div>

		<div class="form-group">
			<label for="indicators-input" class="col-md-2 control-label" translate="shared.indicators"></label>
			<div class="col-sm-10">
				<ui-select multiple ng-model="container.chosenIndicatorIds" theme="bootstrap" acl-has-project-role="owner">
					<ui-select-match placeholder="">{{$item.name}}</ui-select-match>
					<ui-select-choices repeat="indicator._id as indicator in availableIndicators">{{indicator.name}}</ui-select-choices>
				</ui-select>

				<span acl-lacks-project-role="owner">
					{{container.chosenIndicators | getObjects:availableIndicators | pluck:'name' | join:', '}}
				</span>
			</div>
		</div>
	</fieldset>

	<fieldset>
		<legend translate="project.input_form"></legend>

		<!-- FIXME move this to another file... -->
		<script type="text/ng-template" id="form-sub-element.html">
			<div class="panel-heading">
				<i class="fa fa-pencil" ng-if="indicator.type === 'input'"></i>
				<i class="fa fa-calculator" ng-if="indicator.type.substring(0, 'compute'.length) === 'compute'"></i>
				<i class="fa fa-link" ng-if="indicator.type.substring(0, 'link'.length) === 'link'"></i>

				<span ng-if="!key"><span translate="shared.indicator"></span>: </span>
				<span ng-if="key"><span translate="indicator.parameter"></span> <strong>"{{key}}"</strong>: </span>
				{{indicator.name}}
			</div>
			<div class="panel-body">
				<div class="form-group">
					<label class="col-sm-2 control-label" translate="project.indicator_source"></label>
					<div class="col-sm-10">
						<select class="form-control"
								ng-model="indicator.type"
								ng-change="sourceChanged(indicator)"
								ng-options="i.value as i.label group by i.group for i in indicator.availableTypes">
						</select>
					</div>
				</div>

				<div class="form-group" ng-if="indicator.type == 'input'">
					<label class="col-sm-2 control-label" translate="project.source"></label>
					<div class="col-sm-10">
						<input type="text" class="form-control" ng-model="indicator.source" />
					</div>
				</div>

				<div class="panel panel-info"
					 ng-repeat="(key, indicator) in indicator.parameters"
					 ng-include="'form-sub-element.html'"></div>
			</div>
		</script>
	
		<div class="panel panel-primary" ng-repeat="indicator in formElements" ng-include="'form-sub-element.html'"></div>


		<!-- [
			{
				id: "{indicatorId}",
				name: "{indicatorName}",
				source: "sdfjskldf"
				availableInputs: [
					{value: 'input', label: '', group: null},
					{value: 'link:6b533df6-a3e7-486c-b786-99031480c6d0', label: 'another indicator name', group: "link"},
					{value: 'link:f435209b-778d-480c-ae24-47594d1e1cee', label: 'another indicator name 2', group: "link"},
					{value: 'compute:738efc88-7c00-4ce4-b451-5cfccd0130ea', label: "formula name", group: "formula"}
				],
				input: "link:6b533df6-a3e7-486c-b786-99031480c6d0",
				dependencies: {
					a: **RECURSE**,
					b: **RECURSE**
				}
			}
		]




		<script type="text/ng-template" id="field_renderer.html">
			{{key}}: 
			{{indicatorsById[field.id].name}}

			<select ng-options="">
				<option>Input</option>
			</select>

			<ul>
				<li ng-repeat="(key, field) in field.parameters" ng-include="'field_renderer.html'"></li>
			</ul>
		</script>

		<ul>
			<li ng-repeat="field in form.fields" ng-include="'field_renderer.html'"></li>
		</ul>

<table class="table table-bordered table-stripped">
	<thead>
		<tr>
			<th translate="project.sumable"></th>
			<th translate="project.input_field"></th>
			<th translate="project.value_source"></th>
			<th translate="project.input_mode" acl-has-project-role="owner"></th>
		</tr>
	</thead>
	<tbody>
		<tr ng-repeat="(indicatorId, field) in form.fields">
			<td>
				<i class="fa fa-check" style="color: green" ng-show="indicatorsById[indicatorId].sumAllowed"></i>
				<i class="fa fa-times" style="color: red" ng-hide="indicatorsById[indicatorId].sumAllowed"></i>
			</td>
			<td>{{indicatorsById[indicatorId].name}}</td>
			<td acl-has-project-role="owner" acl-fallback="field.source">
				<input type="text" ng-model="field.source" class="form-control" />
			</td>
			<td acl-has-project-role="owner">
				<div class="btn-group">
					<button class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
						{{'project.manual_input'|translate}}
						<span class="caret"></span>
					</button>
					<ul class="dropdown-menu" role="menu">
						<li ng-repeat="(formulaId, formula) in indicatorsById[indicatorId].formulas">
							<a ng-click="useFormula(indicatorId, formulaId)">{{formula.name}}</a>
						</li>
					</ul>
				</div>
			</td>
		</tr>
	</tbody>
</table>
-->
	</fieldset>

	<div acl-has-project-role="owner">
		<br/>
		<button ng-click="save()" ng-disabled="formForm.$invalid || isUnchanged()" class="btn btn-primary">
			<i class="fa fa-floppy-o"></i>
			<span translate="shared.save"></span>
		</button>

		<button ng-click="reset()" ng-disabled="isUnchanged()" class="btn btn-default">
			<i class="fa fa-undo"></i>
			<span translate="shared.remove_changes"></span>
		</button>
	</div>
</form>
