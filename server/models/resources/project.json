{
	"$schema": "http://json-schema.org/schema#",
	"title": "Monitool project schema",
	"type": "object",
	"additionalProperties": false,
	"required": [ "_id", "type", "name", "themes", "start", "end", "entities", "groups", "forms", "crossCutting", "logicalFrames", "users", "extraIndicators"],

	"properties": {
		"_id": { "$ref": "#/definitions/uuid" },
		"_rev": { "$ref": "#/definitions/revision" },
		"type": { "type": "string", "pattern": "^project$" },
		"country": { "type": "string", "minLength": 1 },
		"name": { "type": "string", "minLength": 1 },
		"start": { "type": "string", "format": "date" },
		"end": { "type": "string", "format": "date" },

		"entities": {
			"type": "array",
			"items": {
				"id": { "$ref": "#/definitions/uuid" },
				"name": { "type": "string", "minLength": 1 },
				"start": { "oneOf": [{"type": "null"}, { "type": "string", "format": "date" }]},
				"end": { "oneOf": [{"type": "null"}, { "type": "string", "format": "date" }]}
			}
		},

		"groups": {
			"type": "array",
			"items": {
				"type": "object",
				"properties": {
					"id": { "$ref": "#/definitions/uuid" },
					"name": { "type": "string", "minLength": 1 },
					"members": { "type": "array", "items": { "$ref": "#/definitions/uuid" } }
				}
			}
		},
	
		"forms": {
			"type": "array",
			"items": {
				"type": "object",
				"additionalProperties": false,
				"required": ["id", "name", "collect", "periodicity", "start", "end", "elements"],
				"properties": {
					"id": { "$ref": "#/definitions/uuid" },
					"name": { "type": "string", "minLength": 1 },
					"entities": { "type": "array", "items": { "$ref": "#/definitions/uuid" } },
					"collect": { "type": "string", "enum": ["project", "entity", "some_entity"] },
					"periodicity": { "type": "string", "enum": ["day", "week_sat", "week_sun", "week_mon", "month", "quarter", "year", "free"] },
					"start": { "oneOf": [{"type": "null"}, { "type": "string", "format": "date" }]},
					"end": { "oneOf": [{"type": "null"}, { "type": "string", "format": "date" }]},
					"elements": {
						"type": "array",
						"items": {
							"type": "object",
							"additionalProperties": false,
							"required": ["id", "name", "timeAgg", "geoAgg", "partitions", "order", "distribution"],
							"properties": {
								"id": { "$ref": "#/definitions/uuid" },
								"name": { "type": "string", "minLength": 1 },
								"timeAgg": { "type": "string", "enum": ["none", "sum", "average", "highest", "lowest", "last"] },
								"geoAgg": { "type": "string", "enum": ["none", "sum", "average", "highest", "lowest", "last"] },
								"partitions": { "$ref": "#/definitions/partitions" },
								"order": { "type": "number" },
								"distribution": { "type": "number" }
							}
						}
					}
				}
			}
		},

		"users": {
			"type": "array",
			"items": {
				"oneOf": [
					{
						"type": "object",
						"additionalProperties": false,
						"required": ["type", "id", "role"],
						"properties": {
							"type": {"type": "string", "pattern": "^internal$"},
							"id": {"type": "string", "pattern": "^usr:[a-z0-9\\.\\-\\_]+$"},
							"role": {"type": "string", "enum": ["owner", "input_all", "input", "read"]},
							"entities": {"type": "array", "items": { "$ref": "#/definitions/uuid_or_none" } }
						}
					},
					{
						"type": "object",
						"additionalProperties": false,
						"required": ["name", "password", "role", "type", "username"],
						"properties": {
							"type": {"type": "string", "pattern": "^partner$"},
							"name": {"type": "string", "minLength": 1},
							"role": {"type": "string", "enum": ["owner", "input_all", "input", "read"]},

							"username": {"type": "string", "minLength": 1},
							"password": {
								"oneOf": [
									{"type": "string", "minLength": 6},
									{"type": "null"}
								]
							},

							"entities": {
								"type": "array",
								"items": { "$ref": "#/definitions/uuid_or_none" }
							}
						}
					}
				]
			}
		},

		"themes": {
			"type": "array",
			"uniqueItems": true,
			"items": { "$ref": "#/definitions/uuid" }
		},
		
		"logicalFrames": {
			"type": "array",
			"items": {
				"type": "object",
				"additionalProperties": false,
				"required": ["name", "goal", "indicators", "purposes"],
				"properties": {
					"name": { "type": "string" },
					"goal": { "type": "string" },
					"indicators": { "$ref": "#/definitions/indicators" },
					"purposes": {
						"type": "array",
						"items": {
							"type": "object",
							"additionalProperties": false,
							"required": ["description", "assumptions", "indicators", "outputs"],
							"properties": {
								"description": { "type": "string" },
								"assumptions": { "type": "string" },
								"indicators": { "$ref": "#/definitions/indicators" },
								"outputs": {
									"type": "array",
									"items": {
										"type": "object",
										"additionalProperties": false,
										"required": ["description", "assumptions", "indicators"],
										"properties": {
											"description": { "type": "string" },
											"assumptions": { "type": "string" },
											"indicators": { "$ref": "#/definitions/indicators" }
										}
									}
								}
							}
						}
					}
				}
			}
		},

		"crossCutting": {
			"type": "object",
			"additionalProperties": false,
			"patternProperties": {
				"^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$": {
					"$ref": "#/definitions/cc_indicator"
				}
			}
		},

		"extraIndicators": {
			"type": "array",
			"items": {"$ref": "#/definitions/indicator"}
		}
	},

	"definitions": {
		"uuid": {
			"type": "string",
			"pattern": "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$"
		},
		"uuid_or_none": {
			"type": "string",
			"pattern": "^(([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})|(none))$"
		},
		"revision": {
			"type": "string",
			"pattern": "^[0-9]+\\-[0-9a-f]{32}$"
		},

		"partitions": {
			"type": "array",
			"items": {
				"type": "object",
				"additionalProperties": false,
				"required": ["id", "name", "aggregation", "elements", "groups"],
				"properties": {
					"id": { "$ref": "#/definitions/uuid" },
					"name": { "type": "string", "minLength": 1 },
					"aggregation": { "type": "string", "enum": ["none", "sum", "average", "highest", "lowest", "last"] },
					"elements": {
						"type": "array",
						"items": {
							"type": "object",
							"additionalProperties": false,
							"required": ["id", "name"],
							"properties": {
								"id": { "$ref": "#/definitions/uuid" },
								"name": { "type": "string", "minLength": 1 }
							}
						}
					},

					"groups": {
						"type": "array",
						"items": {
							"type": "object",
							"additionalProperties": false,
							"required": ["id", "name", "members"],
							"properties": {
								"id": { "$ref": "#/definitions/uuid" },
								"name": { "type": "string", "minLength": 1 },
								"members": {
									"type": "array",
									"items": { "$ref": "#/definitions/uuid" }
								}
							}
						}
					}
				}
			}
		},

		"computation": {

			"oneOf": [
				{
					"type": "object",
					"additionalProperties": false,
					"required": ["formula", "parameters"],
					"properties": {

						"formula": {
							"type": "string",
							"minLength": 1
						},

						"parameters": {
							"type": "object",
							"additionalProperties": false,
							"patternProperties": {
								".*": {
									"type": "object",
									"additionalProperties": false,
									"required": ["elementId", "filter"],
									"properties": {
										"elementId": {"$ref": "#/definitions/uuid"},
										"filter": {
											"type": "object",
											"additionalProperties": false,
											"patternProperties": {
												".*": {
													"type": "array",
													"items": {"$ref": "#/definitions/uuid"}
												}
											}
										}
									}
								}
							}
						}
					}	
				},
				{"type": "null"}
			]
		},

		"indicator": {
			"type": "object",
			"additionalProperties": false,
			"required": ["baseline", "target", "colorize", "display", "computation"],
			"properties": {
				"display": {"type": "string", "minLength": 1},
				"baseline": {"oneOf": [{"type": "null"}, {"type": "number"}]},
				"target": {"oneOf": [{"type": "null"}, {"type": "number"}]},
				"colorize": {"type": "boolean"},
				"computation": { "$ref": "#/definitions/computation" }
			}
		},

		"cc_indicator": {
			"type": "object",
			"additionalProperties": false,
			"required": ["baseline", "target", "colorize", "computation"],
			"properties": {
				"baseline": {"oneOf": [{"type": "null"}, {"type": "number"}]},
				"target": {"oneOf": [{"type": "null"}, {"type": "number"}]},
				"colorize": {"type": "boolean"},
				"computation": { "$ref": "#/definitions/computation" }
			}
		},

		"indicators": {
			"type": "array",
			"items": { "$ref": "#/definitions/indicator" }
		}
	}
}