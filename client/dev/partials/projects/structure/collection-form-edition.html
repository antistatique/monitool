<ol class="breadcrumb">
	<li ng-if="userCtx.type == 'user'"><a ui-sref="main.projects" translate="shared.projects"></a></li>
	<li><a ui-sref="main.project.structure.basics" ng-bind="project.name"></a></li>
	<li><a ui-sref="main.project.structure.collection_form_list" translate="project.collection_form_list"></a></li>
	<li class="active">{{project.forms[currentFormIndex].name}}</li>
</ol>

<div class="alert alert-danger noprint" ng-if="formUsage.length" acl-has-project-role="owner">
	 <span ng-bind-html="'project.collection_form_warning'|translate:{num_inputs:formUsage.length}|unsafe"></span>
</div>

<form class="form-horizontal" role="form" name="dataSourceForm" novalidate>
	<legend translate="project.collection_form_planning"></legend>
	
	<div class="form-group" show-errors>
		<label for="input-name" class="col-sm-2 control-label" translate="shared.name"></label>
		<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="project.forms[currentFormIndex].name">
			<input type="text"
				   class="form-control"
				   id="input-name"
				   name="name"
				   ng-model="project.forms[currentFormIndex].name"
				   placeholder="{{'project.form_name_ph'|translate}}"
				   required />
			
			<p class="help-block" ng-if="dataSourceForm.name.$error.required" translate="form.mandatory"></p>
		</div>
	</div>

	<div class="form-group">
		<label for="collect-input" class="col-sm-2 control-label" translate="project.collect"></label>
		<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="('project.collects.' + project.forms[currentFormIndex].collect) | translate">
			<select class="form-control" name="collect" id="collect-input" ng-model="project.forms[currentFormIndex].collect">
				<option value="some_entity" translate="project.collects.some_entity"></option>
				<option value="entity" translate="project.collects.entity"></option>
				<option value="project" translate="project.collects.project"></option>
			</select>
		</div>
	</div>

	<div class="form-group" ng-if="project.forms[currentFormIndex].collect == 'some_entity'">
		<label for="entities-input" class="col-sm-2 control-label" translate="project.collection_site_list"></label>
		<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="project.forms[currentFormIndex].entities | getObjects:project.entities | pluck:'name' | join:', '">
			<ui-select multiple ng-model="project.forms[currentFormIndex].entities" theme="bootstrap" ui-required="true">
				<ui-select-match placeholder="">{{$item.name|translate}}</ui-select-match>
				<ui-select-choices repeat="entity.id as entity in project.entities">
					{{entity.name|translate}}
				</ui-select-choices>
			</ui-select>
		</div>
	</div>

	<div class="form-group">
		<label for="periodicity-input" class="col-sm-2 control-label" translate="project.periodicity"></label>
		<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="('project.periodicities.' + project.forms[currentFormIndex].periodicity) | translate">
			<select class="form-control" name="periodicity" id="periodicity-input" ng-model="project.forms[currentFormIndex].periodicity">
				<option value="day" translate="project.periodicities.day"></option>
				<option value="week" translate="project.periodicities.week"></option>
				<option value="month" translate="project.periodicities.month"></option>
				<option value="quarter" translate="project.periodicities.quarter"></option>
				<option value="year" translate="project.periodicities.year"></option>
				<option value="free" translate="project.periodicities.free"></option>
			</select>
		</div>
	</div>

	<div class="form-group" ng-if="project.forms[currentFormIndex].periodicity !== 'free'">
		<label for="periodicity" class="col-sm-2 control-label" translate="shared.start"></label>
		<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="(project.forms[currentFormIndex].start || project.start)|date">
			<optional-date ng-model="project.forms[currentFormIndex].start" default="project.start"></optional-date>
		</div>
	</div>

	<div class="form-group" ng-if="project.forms[currentFormIndex].periodicity !== 'free'">
		<label for="periodicity" class="col-sm-2 control-label" translate="shared.end"></label>
		<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="(project.forms[currentFormIndex].end || project.end)|date">
			<optional-date ng-model="project.forms[currentFormIndex].end" default="project.end"></optional-date>
		</div>
	</div>

	<legend translate="project.collection_form_structure"></legend>

	<!-- Editable table -->
	<table class="table table-bordered table-condensed table-aggregated-data">
		<thead>
			<tr>
				<th style="width: 30px" acl-has-project-role="owner"></th>
				<th translate="project.variable"></th>
				<th translate="project.aggregation" style="width: 140px" acl-has-project-role="owner"></th>
				<th translate="project.partitions"></th>
				<th style="width: 30px" acl-has-project-role="owner"></th>
			</tr>
		</thead>
		<tbody ng-sortable="variableSortOptions" ng-mouseenter="onSortableMouseEvent('variable', true)" ng-mouseleave="onSortableMouseEvent('variable', false)">
			<!-- variable row -->
			<tr ng-repeat="element in project.forms[currentFormIndex].elements track by element.id">

				<td class="handle variable-handle" acl-has-project-role="owner"><i class="fa fa-bars"></i></td>

				<!-- variable name -->
				<td acl-has-project-role="owner" acl-fallback="element.name">
					<textarea full-height type="text" ng-model="element.name" required class="form-control"></textarea>
				</td>
				
				<!-- variable aggregation -->
				<td acl-has-project-role="owner">
					{{'project.sites_agg'|translate}}<br/>
					<select ng-model="element.geoAgg">
						<option value="none" translate="project.none"></option>
						<option value="sum" translate="project.sum"></option>
						<option value="average" translate="project.average"></option>
						<option value="highest" translate="project.highest"></option>
						<option value="lowest" translate="project.lowest"></option>
						<option value="last" translate="project.last"></option>
					</select><br/>

					{{'project.time_agg'|translate}}<br/>
					<select ng-model="element.timeAgg">
						<option value="none" translate="project.none"></option>
						<option value="sum" translate="project.sum"></option>
						<option value="average" translate="project.average"></option>
						<option value="highest" translate="project.highest"></option>
						<option value="lowest" translate="project.lowest"></option>
						<option value="last" translate="project.last"></option>
					</select>
				</td>

				<!-- variable partitions -->
				<td style="position: relative; padding-bottom: 23px; ">
					<span translate="project.no_partitions" ng-if="element.partitions.length == 0"></span>


					<ul acl-lacks-project-role="owner">
						<li ng-repeat="partition in element.partitions" style="margin-bottom: 2px">
							<strong>{{partition.name}}</strong>

							<span ng-repeat="group in partition.groups">
								<span class="label label-info"><i class="fa fa-arrow-circle-right"></i> {{group.name}}</span>
							</span>
							
							<span ng-repeat="element in partition.elements">
								<span class="label label-default">{{element.name}}</span>
							</span>
						</li>
					</ul>

					<ul acl-has-project-role="owner"
						ng-sortable="partitionSortOptions"
					    ng-mouseenter="onSortableMouseEvent('partition', true)"
					    ng-mouseleave="onSortableMouseEvent('partition', false)">

						<li ng-repeat="partition in element.partitions" style="margin-bottom: 2px">

							<a class="btn btn-xxs btn-default pull-right"
							   ng-click="editPartition(element.id, partition.id)">

								<i class="fa fa-fw fa-pencil"></i>
								<span translate="shared.edit"></span>
							</a>

							<i class="fa fa-bars partition-handle"></i>

							<strong>{{partition.name}}</strong>
							
							<span class="sortable-label-list"
								  ng-sortable="groupSortOptions"
								  ng-mouseenter="onSortableMouseEvent('group', true)"
								  ng-mouseleave="onSortableMouseEvent('group', false)">

								<span ng-repeat="group in partition.groups">
									<span class="label label-info"><i class="fa fa-arrow-circle-right"></i> {{group.name}}</span>
								</span>
							</span>
							
							<span class="sortable-label-list"
								  ng-sortable="elementSortOptions"
								  ng-mouseenter="onSortableMouseEvent('element', true)"
								  ng-mouseleave="onSortableMouseEvent('element', false)">

								<span ng-repeat="element in partition.elements">
									<span class="label label-default">{{element.name}}</span>
								</span>
							</span>
						</li>
					</ul>

					<a ng-click="editPartition(element.id, null)"
					   class="btn btn-xxs btn-default"
					   style="position: absolute; bottom: 4px; right: 3px"
					   acl-has-project-role="owner">

						<i class="fa fa-plus"></i>
						<span translate="project.add_partition"></span>
					</a>
				</td>

				<!-- variable actions -->
				<td acl-has-project-role="owner">
					<a class="btn btn-danger btn-sm" ng-click="remove(element, project.forms[currentFormIndex].elements)">
						<i class="fa fa-remove"></i>
					</a>
				</td>
 			</tr>
		</tbody>
		<tfoot>
 			<!-- add new variable row --> 
			<tr acl-has-project-role="owner">
				<td colspan="5" style="text-align: center">
					<a ng-click="newVariable()" class="btn btn-xs btn-default">
						<i class="fa fa-plus"></i>
						<span translate="project.add_variable"></span>
					</a>
				</td>
			</tr>
		</tfoot>
	</table>
</form>

<div acl-has-project-role="owner" class="pull-right">
	<button ng-click="deleteForm()" ng-if="master.forms[currentFormIndex]" class="btn btn-danger">
		<i class="fa fa-times"></i>
		<span translate="shared.delete"></span>
	</button>
</div>
