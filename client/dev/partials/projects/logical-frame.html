<ol class="breadcrumb">
	<li><a ui-sref="main.projects" translate="shared.projects"></a></li>
	<li class="active">{{project.name}}</li>
	<li class="active" translate="shared.logical_frame"></li>
</ol>

<form class="form-horizontal" role="form" name="projectForm" novalidate>
	<fieldset>
		<legend translate="project.general_data"></legend>

		<div class="form-group" show-errors>
			<label for="input-name" class="col-sm-2 control-label" translate="shared.name"></label>
			<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="project.name">
				<input type="text"
					   class="form-control"
					   id="input-name"
					   name="name"
					   ng-model="project.name"
					   placeholder="{{'project.name_ph'|translate}}"
					   required />
				
				<p class="help-block" ng-if="projectForm.name.$error.required" translate="form.mandatory"></p>
			</div>
		</div>

		<div class="form-group" show-errors>
			<label for="input-begin" class="col-sm-2 control-label" translate="project.begin_date"></label>
			<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="project.begin">

				<input type="text" 
					   datepicker-popup="yyyy/MM/dd"
					   name="begin"
					   ng-model="project.begin"
					   is-open="beginDateOpen"
					   show-button-bar="false"
					   ng-click = "beginDateOpen = true"
					   starting-day="1"
					   show-weeks="0"
					   required
					   ng-max="project.end"
					   class="form-control" />

				<p class="help-block" ng-if="projectForm.begin.$error.required" translate="form.mandatory"></p>
				<p class="help-block" ng-if="projectForm.begin.$error.lowerThan" translate="form.begin_lower_than_end"></p>
			</div>
		</div>


		<div class="form-group" show-errors>
			<label for="input-end" class="col-sm-2 control-label" translate="project.end_date"></label>
			<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="project.end">

				<input type="text" 
					   datepicker-popup="yyyy/MM/dd"
					   name="end"
					   ng-model="project.end"
					   is-open="endDateOpen"
					   show-button-bar="false"
					   ng-click = "endDateOpen = true"
					   starting-day="1"
					   show-weeks="0"
					   required
					   ng-min="project.begin"
					   class="form-control" />

				<p class="help-block" ng-if="projectForm.end.$error.required" translate="form.mandatory"></p>
				<p class="help-block" ng-if="projectForm.end.$error.greaterThan" translate="form.end_greater_than_begin"></p>
			</div>
		</div>
	</fieldset>

	<fieldset>
		<legend translate="project.goal"></legend>
		<div class="form-group" show-errors>
			<label for="logframe-goal-input" class="col-sm-2 control-label" translate="project.intervention_logic"></label>

			<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="project.logicalFrame.goal">
				<textarea class="form-control"
						  name="goalDesc"
						  id="logframe-goal-input"
						  required
						  placeholder="{{'project.intervention_logic_goal_ph'|translate}}"
						  ng-model="project.logicalFrame.goal"></textarea>

				<p class="help-block" ng-if="projectForm.goalDesc.$error.required" translate="form.mandatory"></p>
			</div>
		</div>

		<div class="form-group">
			<label class="col-sm-2 control-label" translate="shared.indicators"></label>
			<div class="col-sm-10">
				<ul class="form-control-static">
					<li ng-repeat="indicatorId in project.logicalFrame.indicators">
						{{indicatorsById[indicatorId].name}}
						<span acl-has-project-role="owner">(<a ng-click="editIndicator(indicatorId, project.logicalFrame.indicators)" translate="shared.edit"></a> |
							<a ng-click="detachIndicator(indicatorId, project.logicalFrame.indicators)" translate="shared.detach"></a>)</span>
						<span acl-lacks-project-role="owner">(<a ng-click="editIndicator(indicatorId, project.logicalFrame.indicators)" translate="shared.display"></a>)</span>
					</li>
					<li acl-has-project-role="owner">
						<a ng-click="editIndicator('new', project.logicalFrame.indicators)" translate="project.add_indicator"></a>
					</li>
				</ul>
			</div>
		</div>
	</fieldset>

	<fieldset>
		<legend translate="project.purposes"></legend>
		
		<div class="panel panel-primary" ng-repeat="(purposeId, purpose) in project.logicalFrame.purposes" ng-init="tabOpen=false">

			<div class="panel-heading">
				<div class="panel-title">
					<button class="btn btn-danger btn-xs pull-right" ng-click="removePurpose(purpose)" acl-has-project-role="owner">
						<i class="fa fa-remove"></i>
						<span translate="shared.delete"></span>
					</button>

					<i class="fa" ng-class="{'fa-minus-circle': tabOpen, 'fa-plus-circle': !tabOpen}"></i>
					<a ng-click="tabOpen = !tabOpen"> {{'project.purpose'|translate}} {{purposeId + 1}}: {{purpose.description}}</a>
				</div>
			</div>

			<div class="panel-body" ng-show="tabOpen">
				<ng-form name="purposeForm">
					<div class="form-group" show-errors>
						<label for="purpose-desc-{{purposeId}}-input" class="col-sm-2 control-label" translate="project.intervention_logic"></label>
						<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="purpose.description">
							<input type="text"
								   class="form-control"
								   name="description"
								   id="purpose-desc-{{purposeId}}-input"
								   placeholder="{{'project.intervention_logic_purpose_ph'|translate}}"
								   ng-model="purpose.description"
								   required />

							<p class="help-block" ng-if="purposeForm.description.$error.required" translate="form.mandatory"></p>
						</div>
					</div>

					<div class="form-group" show-errors>
						<label for="purpose-assum-{{purposeId}}-input" class="col-sm-2 control-label" translate="project.assumptions"></label>
						<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="purpose.assumptions">
							<textarea class="form-control"
									  name="assumptions"
									  id="purpose-assum-{{purposeId}}-input"
									  placeholder="{{'project.assumptions_purpose_ph'|translate}}"
									  ng-model="purpose.assumptions"
									  required></textarea>

							<p class="help-block" ng-if="purposeForm.assumptions.$error.required" translate="form.mandatory"></p>
						</div>
					</div>

					<div class="form-group">
						<label class="col-sm-2 control-label" translate="shared.indicators"></label>
						<div class="col-sm-10">
							<ul class="form-control-static">
								<li ng-repeat="indicatorId in purpose.indicators">
									{{indicatorsById[indicatorId].name}}
									<span acl-has-project-role="owner">(<a ng-click="editIndicator(indicatorId, purpose.indicators)" translate="shared.edit"></a> |
										<a ng-click="detachIndicator(indicatorId, purpose.indicators)" translate="shared.detach"></a>)</span>
									<span acl-lacks-project-role="owner">(<a ng-click="editIndicator(indicatorId, purpose.indicators)" translate="shared.display"></a>)</span>
								</li>
								<li acl-has-project-role="owner">
									<a ng-click="editIndicator('new', purpose.indicators)" translate="project.add_indicator"></a>
								</li>
							</ul>
						</div>
					</div>

					<div class="panel panel-info" ng-repeat="(outputId, output) in purpose.outputs" ng-init="tabOpen=false">
						<div class="panel-heading">
							<div class="panel-title">
								<button class="btn btn-danger btn-xs pull-right" ng-click="removeOutput(output, purpose)" acl-has-project-role="owner">
									<i class="fa fa-remove"></i>
									<span translate="shared.delete"></span>
								</button>

								<i class="fa" ng-class="{'fa-minus-circle': tabOpen, 'fa-plus-circle': !tabOpen}"></i>
								<a ng-click="tabOpen = !tabOpen"> {{'project.output'|translate}} {{purposeId + 1}}.{{outputId + 1}}: {{output.description}}</a>
							</div>
						</div>

						<div class="panel-body" ng-show="tabOpen">
							<ng-form name="outputForm">
								<div class="form-group" show-errors>
									<label for="output-desc-{{purposeId}}-{{outputId}}-input" class="col-sm-2 control-label" translate="shared.description"></label>
									<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="output.description">
										<textarea class="form-control"
												  required
												  id="output-desc-{{purposeId}}-{{outputId}}-input"
												  name="description"
												  placeholder="{{'project.output_desc_ph'|translate}}"
												  ng-model="output.description"></textarea>

										<p class="help-block" ng-if="outputForm.description.$error.required" translate="form.mandatory"></p>
									</div>
								</div>

								<div class="form-group" show-errors>
									<label for="output-assump-{{purposeId}}-{{outputId}}-input" class="col-sm-2 control-label" translate="project.assumptions"></label>
									<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="output.assumptions">
										<textarea class="form-control"
												  required
												  id="output-assump-{{purposeId}}-{{outputId}}-input"
												  name="assumptions"
												  placeholder="{{'project.output_assumptions_ph'|translate}}"
												  ng-model="output.assumptions"></textarea>

										<p class="help-block" ng-if="outputForm.assumptions.$error.required" translate="form.mandatory"></p>
									</div>
								</div>

								<div class="form-group">
									<label class="col-sm-2 control-label" translate="shared.indicators"></label>
									<div class="col-sm-10">
										<ul class="form-control-static">
											<li ng-repeat="indicatorId in output.indicators">
												{{indicatorsById[indicatorId].name}}
												<span acl-has-project-role="owner">(<a ng-click="editIndicator(indicatorId, output.indicators)" translate="shared.edit"></a> |
													<a ng-click="detachIndicator(indicatorId, output.indicators)" translate="shared.detach"></a>)</span>

												<span acl-lacks-project-role="owner">(<a ng-click="editIndicator(indicatorId, output.indicators)" translate="shared.display"></a>)</span>
											</li>
											<li acl-has-project-role="owner">
												<a ng-click="editIndicator('new', output.indicators)" translate="project.add_indicator"></a>
											</li>
										</ul>
									</div>
								</div>

								<div class="panel panel-default" ng-repeat="(activityId, activity) in output.activities" ng-init="tabOpen=false">
									<div class="panel-heading">
										<div class="panel-title">
											<button class="btn btn-danger btn-xs pull-right" ng-click="removeActivity(activity, output)" acl-has-project-role="owner">
												<i class="fa fa-remove"></i>
												<span translate="shared.delete"></span>
											</button>
											<i class="fa" ng-class="{'fa-minus-circle': tabOpen, 'fa-plus-circle': !tabOpen}"></i>
											<a ng-click="tabOpen = !tabOpen"> {{'project.activity'|translate}} {{purposeId + 1}}.{{outputId + 1}}.{{activityId + 1}}: {{activity.description}}</a>
										</div>
									</div>

									<div class="panel-body" ng-show="tabOpen">
										<ng-form name="activityForm">
											<div class="form-group" show-errors>
												<label for="activity-desc-{{purposeId}}-{{outputId}}-{{activityId}}-input"
													   class="col-sm-2 control-label"
													   translate="shared.description"></label>

												<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="activity.description">
													<input type="text"
														   id="activity-desc-{{purposeId}}-{{outputId}}-{{activityId}}-input"
														   class="form-control"
														   name="description"
														   placeholder="{{'project.activity_desc_ph'|translate}}"
														   ng-model="activity.description"
														   required/>

													<p class="help-block" ng-if="activityForm.description.$error.required" translate="form.mandatory"></p>
												</div>
											</div>

											<div class="form-group" show-errors>
												<label for="activity-prereq-{{purposeId}}-{{outputId}}-{{activityId}}-input"
													   class="col-sm-2 control-label"
													   translate="project.prerequisite"></label>

												<div class="col-sm-10" acl-has-project-role="owner" acl-fallback="activity.prerequisites">
													<input type="text"
														   id="activity-prereq-{{purposeId}}-{{outputId}}-{{activityId}}-input"
														   class="form-control"
														   placeholder="{{'project.activity_prereq_ph'|translate}}"
														   ng-model="activity.prerequisites"
														   name="prerequisites"
														   required/>

													<p class="help-block" ng-if="activityForm.prerequisites.$error.required" translate="form.mandatory"></p>
												</div>
											</div>
										</ng-form>
									</div>
								</div>

								<button class="btn btn-default" ng-click="addActivity(output)" acl-has-project-role="owner">
									<i class="fa fa-plus"></i>
									<span translate="project.add_activity"></span>
								</button>
							</ng-form>
						</div>
					</div>
					
					<button class="btn btn-default" ng-click="addOutput(purpose)" acl-has-project-role="owner">
						<i class="fa fa-plus"></i>
						<span translate="project.add_output"></span>
					</button>
				</ng-form>
			</div>
		</div>

		<button class="btn btn-default" ng-click="addPurpose()" acl-has-project-role="owner">
			<i class="fa fa-plus"></i>
			<span translate="project.add_purpose"></span>
		</button>
	</fieldset>
	<br/>

	<fieldset>
		<legend>Indicateurs supplémentaires</legend>

		<ul class="form-control-static">
			<li ng-repeat="indicatorId in otherIndicators">
				{{indicatorsById[indicatorId].name}}
				<span acl-has-project-role="owner">(<a ng-click="editIndicator(indicatorId, null)" translate="shared.edit"></a>)</span>
				<span acl-lacks-project-role="owner">(<a ng-click="editIndicator(indicatorId, null)" translate="shared.display"></a>)</span>
			</li>
			<li acl-has-project-role="owner">
				<a ng-click="editIndicator('new', null)" translate="project.add_indicator"></a>
			</li>
		</ul>

	</fieldset>
	
	<div acl-has-project-role="owner">
		<br/><br/>

		<button ng-disabled="projectForm.$invalid || isUnchanged()" class="btn btn-primary" ng-click="save()">
			<i class="fa fa-floppy-o"></i>
			<span translate="shared.save"></span>
		</button>

		<button ng-click="reset()" ng-disabled="isUnchanged()" class="btn btn-default">
			<i class="fa fa-undo"></i>
			<span translate="shared.remove_changes"></span>
		</button>
	</div>
</form>
