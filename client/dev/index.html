<!DOCTYPE html>
<html>
	<head>
		<title>Monitool</title>

		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

		<link rel="stylesheet" type="text/css" href="bower_components/angular-ui-select/dist/select.min.css" />
		<link rel="stylesheet" type="text/css" href="bower_components/bootstrap-css-only/css/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="bower_components/c3/c3.min.css" />
		<link rel="stylesheet" type="text/css" href="bower_components/font-awesome/css/font-awesome.min.css" />
		<link rel="stylesheet" type="text/css" href="bower_components/handsontable/dist/handsontable.full.css" />

		<link rel="stylesheet" type="text/css" href="css/app.css" />

		<script type="text/javascript">
		
			// Work around http://code.google.com/p/chromium/issues/detail?id=331971
			window.onerror = function(errorMsg, url, lineNumber, columnNumber, errorObject) {
				if (errorObject && /<omitted>/.test(errorMsg))
					console.error('Full exception message: ' + errorObject.message);
			};

		</script>

		<script type="text/javascript" src="i18n/fr.js"></script>
		<script type="text/javascript" src="i18n/es.js"></script>
		<script type="text/javascript" src="i18n/en.js"></script>

		<!-- PNG generation -->
		<script type="text/javascript" src="bower_components/blob/Blob.js"></script>
		<script type="text/javascript" src="bower_components/canvas-to-Blob.js/canvas-toBlob.js"></script>
		<script type="text/javascript" src="bower_components/file-saver/FileSaver.min.js"></script>

		<!-- Angular -->
		<script type="text/javascript" src="bower_components/angular/angular.min.js"></script>
		<script type="text/javascript" src="bower_components/angular-bootstrap/ui-bootstrap-tpls.min.js"></script>
		<script type="text/javascript" src="bower_components/angular-ui-router/release/angular-ui-router.min.js"></script>
		<script type="text/javascript" src="bower_components/angular-ui-select/dist/select.min.js"></script>
		<script type="text/javascript" src="bower_components/angular-cookies/angular-cookies.min.js"></script>
		<script type="text/javascript" src="bower_components/angular-resource/angular-resource.min.js"></script>
		<script type="text/javascript" src="bower_components/angular-translate/angular-translate.min.js"></script>
		<script type="text/javascript" src="bower_components/angular-translate-storage-cookie/angular-translate-storage-cookie.min.js"></script>
		<script type="text/javascript" src="bower_components/angular-translate-storage-local/angular-translate-storage-local.min.js"></script>

		<!-- Graphs -->
		<script type="text/javascript" src="bower_components/d3/d3.min.js"></script>
		<script type="text/javascript" src="bower_components/c3/c3.min.js"></script>

		<!-- Excel -->
		<script type="text/javascript" src="bower_components/handsontable/dist/handsontable.full.min.js"></script>

		<!-- Sortable -->
		<script type="text/javascript" src="bower_components/Sortable/Sortable.min.js"></script>
		<script type="text/javascript" src="bower_components/Sortable/ng-sortable.js"></script>

		<script type="text/javascript" src="js/polyfills/array.js"></script>
		<script type="text/javascript" src="js/polyfills/date.js"></script>
		<script type="text/javascript" src="js/polyfills/math.js"></script>

		<script type="text/javascript" src="js/app.js"></script>
		<script type="text/javascript" src="js/controllers/project-shared.js"></script>
		<script type="text/javascript" src="js/controllers/project-structure.js"></script>
		<script type="text/javascript" src="js/controllers/project-input.js"></script>
		<script type="text/javascript" src="js/controllers/project-reporting.js"></script>

		<script type="text/javascript" src="js/controllers/indicator.js"></script>
		<script type="text/javascript" src="js/controllers/admin.js"></script>
		<script type="text/javascript" src="js/controllers/helper.js"></script>

		<script type="text/javascript" src="js/directives/_shared.js"></script>
		<script type="text/javascript" src="js/directives/indicator.js"></script>
		<script type="text/javascript" src="js/directives/reporting.js"></script>
		<script type="text/javascript" src="js/directives/_forms.js"></script>
		<script type="text/javascript" src="js/directives/_acls.js"></script>
		<script type="text/javascript" src="js/directives/project-logframe.js"></script>

		<script type="text/javascript" src="js/filters/indicator.js"></script>
		<script type="text/javascript" src="js/filters/shared.js"></script>

		<script type="text/javascript" src="js/services/models/indicator.js"></script>
		<script type="text/javascript" src="js/services/models/input.js"></script>
		<script type="text/javascript" src="js/services/models/project.js"></script>
		<script type="text/javascript" src="js/services/models/theme.js"></script>
		<script type="text/javascript" src="js/services/models/user.js"></script>

		<script type="text/javascript" src="js/services/statistics/reporting.js"></script>
		<script type="text/javascript" src="js/services/statistics/olap.js"></script>
		<script type="text/javascript" src="js/services/statistics/parser.js"></script>

		<script type="text/javascript" src="js/services/utils/input-slots.js"></script>
		<script type="text/javascript" src="js/services/utils/itertools.js"></script>
		<script type="text/javascript" src="js/services/utils/string.js"></script>
		<script type="text/javascript" src="js/services/utils/translate.js"></script>
		<script type="text/javascript" src="js/services/utils/uuid.js"></script>
	</head>
	<body>
		<div ui-view></div>

		<div id="version">Version 2.5</div>

		<div id="load-container">
			<div id="load-content">
				<img id="logo_img" src="/img/logo_color.svg">
				
				<div id="login_buttons" style="display: none">
					<a href="/authentication/login" class="btn btn-primary btn-lg btn-block">Use MDM account</a>
					<a id="partner_login_btn" href="#" class="btn btn-default btn-lg btn-block">Use partner account</a>
				</div>

				<div id="partner_login" style="display: none">
					<form class="form-horizontal well well-sm" action="/authentication/login-partner" method="POST">
						<legend>Partner authentication</legend>
						<div class="form-group">
							<label for="username" class="col-sm-2 control-label">Username</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="username" name="username" placeholder="Username">
							</div>
						</div>
						<div class="form-group">
							<label for="password" class="col-sm-2 control-label">Password</label>
							<div class="col-sm-10">
								<input type="password" class="form-control" id="password" name="password" placeholder="Password">
							</div>
						</div>
						<div class="form-group">
							<div class="col-sm-6">
								<button type="submit" class="btn btn-primary btn-block">Connect</button>
							</div>
							<div class="col-sm-6">
								<a id="go_back_btn" class="btn btn-default btn-block">Go back</a>
							</div>
						</div>
					</form>
				</div>

				<div id="ie_warning" style="display: none">
					<h3>Monitool cannot be used with a legacy Internet Explorer version</h3>
					<p>Please use either Chrome, Firefox, or a recent version of Internet Explorer.</p>
				</div>

				<div id="server_down" style="display: none">
					<h3>Server seems to be down</h3>
					<h3>Please, try again later</h3>
				</div>

			</div>
		</div>

		<script type="text/javascript">
			
			// From http://stackoverflow.com/a/21712356/1897495
			function getInternetExplorerVersion() {
				var ua = window.navigator.userAgent;

				var msie = ua.indexOf('MSIE ');
				if (msie > 0) {
					// IE 10 or older => return version number
					return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
				}

				var trident = ua.indexOf('Trident/');
				if (trident > 0) {
					// IE 11 => return version number
					var rv = ua.indexOf('rv:');
					return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
				}

				var edge = ua.indexOf('Edge/');
				if (edge > 0) {
					// Edge (IE 12+) => return version number
					return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
				}

				// other browser
				return false;
			}
			
			function onAuthResponse(e) {
				// User is logged on
				if (authReq.status === 200) {
					// Remove modal and change background color
					document.body.style.backgroundColor = 'white';
					document.body.removeChild(document.getElementById('load-container'));
					document.body.removeChild(document.getElementById('version'));

					// Start angular application
					window.user = JSON.parse(authReq.responseText);
					angular.bootstrap(document, ['monitool.app']);
				}
				// User is not logged on
				else if (authReq.status === 401)
					// show login screen
					document.getElementById('login_buttons').style.display = 'block';
				else
					// show error
					document.getElementById('server_down').style.display = 'block';
			}

			function onParterLoginClicked(e) {
				// rezize logo_img
				document.getElementById('logo_img').style.width = '190px';

				// hide login screen, show login form
				document.getElementById('login_buttons').style.display = 'none';
				document.getElementById('partner_login').style.display = 'block';
				e.preventDefault();
			}

			function onGoBackClicked(e) {
				// rezize logo_img
				document.getElementById('logo_img').style.width = '250px';

				// hide login screen, show login form
				document.getElementById('login_buttons').style.display = 'block';
				document.getElementById('partner_login').style.display = 'none';
				e.preventDefault();
			}

			var ieVersion = getInternetExplorerVersion();

			if (ieVersion !== false && ieVersion < 10) {
				document.getElementById('ie_warning').style.display = 'block';
			}
			else {
				document.getElementById('partner_login_btn').addEventListener('click', onParterLoginClicked, false);
				document.getElementById('go_back_btn').addEventListener('click', onGoBackClicked, false);

				var authReq = new XMLHttpRequest();
				authReq.addEventListener("load", onAuthResponse, false);
				authReq.open('GET', '/resources/myself?' + Math.random().toString().substring(2));
				authReq.send();
			}

		</script>
	</body>
</html>
