<!DOCTYPE html>
<html>
	<head>
		<title>Monitool</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="monitool2.css" />
	</head>
	<body>
		<div ui-view></div>
		
		<div id="load-container">
			<div id="load-content">
				<img id="logo_img" src="/img/logo_color.svg">
				
				<div id="login_buttons" style="display: none">
					<a href="/authentication/login" class="btn btn-primary btn-lg btn-block">Use MDM account</a>
					<a id="partner_login_btn" href="#" class="btn btn-default btn-lg btn-block">Use partner account</a>
				</div>

				<div id="partner_login" style="display: none">
					<form class="form-horizontal well well-sm" action="/authentication/login-partner" method="POST">
						<legend>Partner authentication</legend>
						<div class="form-group">
							<label for="username" class="col-sm-2 control-label">Username</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="username" name="username" placeholder="Username">
							</div>
						</div>
						<div class="form-group">
							<label for="password" class="col-sm-2 control-label">Password</label>
							<div class="col-sm-10">
								<input type="password" class="form-control" id="password" name="password" placeholder="Password">
							</div>
						</div>
						<div class="form-group">
							<div class="col-sm-6">
								<button type="submit" class="btn btn-primary btn-block">Connect</button>
							</div>
							<div class="col-sm-6">
								<a id="go_back_btn" class="btn btn-default btn-block">Go back</a>
							</div>
						</div>
					</form>
				</div>

				<div id="server_down" style="display: none">
					<h3>Server seems to be down</h3>
					<h3>Please, try again later</h3>
				</div>

				<div id="loader" style="display: none">
					<h3>Loading</h3>
					
					<div class="progress">
						<div id="progress" class="progress-bar progress-bar-info" style="width: 0"></div>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			
			function onAuthLoaded(e) {
				// User is logged on
				if (authReq.status === 200) {
					// Show loader
					document.getElementById('loader').style.display = 'block';

					// Start loading app
					appReq.send();
				}
				// User is not logged on
				else if (authReq.status === 401)
					// show login screen
					document.getElementById('login_buttons').style.display = 'block';
				else
					// show error
					document.getElementById('server_down').style.display = 'block';
			}

			function onAppProgress(e) {
				document.getElementById('progress').style.width = 100 * event.loaded / 1463944 + '%';
			}

			function onAppLoaded(e) {
				// Remove modal and change background color
				document.body.style.backgroundColor = 'white';
				var loader = document.getElementById('load-container');
				loader.parentNode.removeChild(loader);

				// append main script to document.
				var s = document.createElement("script");
				s.innerHTML = appReq.responseText;
				document.body.appendChild(s);

				// Start angular application
				window.user = JSON.parse(authReq.responseText);
				angular.bootstrap(document, ['monitool.app']);
			}

			function onParterLoginClicked(e) {
				// rezize logo_img
				document.getElementById('logo_img').style.width = '190px';

				// hide login screen, show login form
				document.getElementById('login_buttons').style.display = 'none';
				document.getElementById('partner_login').style.display = 'block';
				e.preventDefault();
			}

			function onGoBackClicked(e) {
				// rezize logo_img
				document.getElementById('logo_img').style.width = '250px';

				// hide login screen, show login form
				document.getElementById('login_buttons').style.display = 'block';
				document.getElementById('partner_login').style.display = 'none';
				e.preventDefault();
			}

			document.getElementById('partner_login_btn').addEventListener('click', onParterLoginClicked, false);
			document.getElementById('go_back_btn').addEventListener('click', onGoBackClicked, false);

			// Configure AJAX requests
			var appReq = new XMLHttpRequest();
			appReq.addEventListener("progress", onAppProgress, false);
			appReq.addEventListener("load", onAppLoaded, false);
			appReq.open("GET", "/monitool2.js");

			var authReq = new XMLHttpRequest();
			authReq.addEventListener("load", onAuthLoaded, false);
			authReq.open('GET', '/resources/myself?' + Math.random().toString().substring(2));
			authReq.send();

		</script>
	</body>
</html>
