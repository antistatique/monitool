# nginx configuration file
# On a debian install, goes at /etc/nginx/sites-enabled/monitool

server {
	# We should deploy on a 80 port, because of corporate proxies
	listen 80 default_server;

	location / {
		proxy_pass http://localhost:5984;
		proxy_redirect off;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		# Enabling gzip compression is mandatory when calling couchdb views
		# On some views the compression level is > 95% because uuidv4s repeat a lot in the documents
		gzip on;
		gzip_buffers 16 8k;
		gzip_vary on;
		gzip_proxied any;
		gzip_comp_level 9;
		gzip_http_version 1.1;
		gzip_types application/json;
	}

	# Disable buffering on _changes to allow long poll
	# gzip should be enabled as well, if not in long poll mode to speed up sync after offline...
	location ~ ^/(.*)/_changes {
		proxy_pass http://localhost:5984;
		proxy_redirect off;
		proxy_buffering off;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
}
